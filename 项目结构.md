# 豆瓣书单同步与 Calibre 集成自动化 - 项目结构

## 目录结构

```
豆瓣zlib/
├── config/
│   ├── __init__.py
│   └── config_manager.py      # 配置文件管理模块
├── data/
│   └── .gitkeep               # 数据存储目录
├── db/
│   ├── __init__.py
│   ├── models.py              # 数据库模型定义
│   └── database.py            # 数据库操作接口
├── scrapers/
│   ├── __init__.py
│   └── douban_scraper.py      # 豆瓣爬虫模块
├── services/
│   ├── __init__.py
│   ├── calibre_service.py     # Calibre 查询与上传服务
│   ├── zlibrary_service.py    # Z-Library 下载服务
│   └── lark_service.py        # 飞书通知服务
├── scheduler/
│   ├── __init__.py
│   └── task_scheduler.py      # 任务调度模块
├── utils/
│   ├── __init__.py
│   ├── logger.py              # 日志工具
│   └── helpers.py             # 辅助函数
├── tests/
│   ├── __init__.py
│   ├── test_scrapers.py       # 爬虫测试
│   ├── test_services.py       # 服务测试
│   └── test_integration.py    # 集成测试
├── logs/
│   └── .gitkeep               # 日志存储目录
├── migrations/
│   └── .gitkeep               # 数据库迁移脚本
├── main.py                    # 主程序入口
├── config.yaml                # 配置文件
├── requirements.txt           # 依赖包列表
├── setup.py                   # 安装脚本
├── README.md                  # 项目说明
└── .gitignore                 # Git 忽略文件
```

## 关键文件说明

### 1. 配置管理

**config/config_manager.py**

负责解析和验证配置文件，提供全局配置访问接口。

```python
# 示例代码结构
class ConfigManager:
    def __init__(self, config_path):
        self.config_path = config_path
        self.config = self._load_config()
    
    def _load_config(self):
        # 加载并验证配置文件
        pass
    
    def get_douban_config(self):
        # 返回豆瓣相关配置
        pass
    
    def get_calibre_config(self):
        # 返回 Calibre 相关配置
        pass
    
    # 其他配置获取方法
```

### 2. 数据库模型

**db/models.py**

定义数据库模型和关系。

```python
# 示例代码结构
from sqlalchemy import Column, Integer, String, DateTime, Text
from sqlalchemy.ext.declarative import declarative_base
from datetime import datetime

Base = declarative_base()

class DoubanBook(Base):
    __tablename__ = 'douban_books'
    
    id = Column(Integer, primary_key=True)
    title = Column(String(255), nullable=False)
    author = Column(String(255))
    douban_url = Column(String(255), unique=True)
    status = Column(String(50))  # new/matched/downloaded/uploaded
    created_at = Column(DateTime, default=datetime.now)
    
    def __repr__(self):
        return f"<DoubanBook(title='{self.title}', author='{self.author}')>"
```

### 3. 数据库操作

**db/database.py**

提供数据库连接和操作接口。

```python
# 示例代码结构
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from .models import Base, DoubanBook

class Database:
    def __init__(self, db_url):
        self.engine = create_engine(db_url)
        self.Session = sessionmaker(bind=self.engine)
    
    def init_db(self):
        # 初始化数据库
        Base.metadata.create_all(self.engine)
    
    def add_book(self, title, author, douban_url):
        # 添加书籍记录
        pass
    
    def update_book_status(self, book_id, status):
        # 更新书籍状态
        pass
    
    def get_books_by_status(self, status):
        # 获取指定状态的书籍
        pass
    
    # 其他数据库操作方法
```

### 4. 豆瓣爬虫

**scrapers/douban_scraper.py**

负责爬取豆瓣书单数据。

```python
# 示例代码结构
import requests
from bs4 import BeautifulSoup

class DoubanScraper:
    def __init__(self, cookie):
        self.cookie = cookie
        self.headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
            'Cookie': cookie
        }
    
    def get_wish_list(self):
        # 获取"想读"书单
        pass
    
    def parse_book_info(self, html):
        # 解析书籍信息
        pass
    
    def run(self):
        # 执行爬虫任务
        pass
```

### 5. Calibre 服务

**services/calibre_service.py**

提供 Calibre 书库查询和上传功能。

```python
# 示例代码结构
import requests

class CalibreService:
    def __init__(self, server_url, username, password):
        self.server_url = server_url
        self.username = username
        self.password = password
    
    def search_book(self, title, author):
        # 搜索书籍
        pass
    
    def upload_book(self, file_path, metadata):
        # 上传书籍
        pass
    
    def _fuzzy_match(self, query, candidates):
        # 模糊匹配算法
        pass
```

### 6. Z-Library 服务

**services/zlibrary_service.py**

提供 Z-Library 书籍搜索和下载功能。

```python
# 示例代码结构
from zlibrary import ZLibrary

class ZLibraryService:
    def __init__(self, username, password, format_priority):
        self.client = ZLibrary(username, password)
        self.format_priority = format_priority
    
    def search_book(self, title, author):
        # 搜索书籍
        pass
    
    def download_book(self, book_id, output_dir):
        # 下载书籍
        pass
    
    def select_best_format(self, available_formats):
        # 按优先级选择最佳格式
        pass
```

### 7. 飞书通知服务

**services/lark_service.py**

提供飞书机器人消息推送功能。

```python
# 示例代码结构
import requests
import json

class LarkService:
    def __init__(self, webhook_url):
        self.webhook_url = webhook_url
    
    def send_message(self, title, content):
        # 发送消息
        pass
    
    def format_task_report(self, stats):
        # 格式化任务报告
        pass
```

### 8. 任务调度

**scheduler/task_scheduler.py**

负责定时任务调度和执行。

```python
# 示例代码结构
from apscheduler.schedulers.background import BackgroundScheduler

class TaskScheduler:
    def __init__(self, config):
        self.scheduler = BackgroundScheduler()
        self.config = config
    
    def setup_jobs(self):
        # 设置定时任务
        pass
    
    def start(self):
        # 启动调度器
        pass
    
    def stop(self):
        # 停止调度器
        pass
    
    def run_sync_task(self):
        # 执行同步任务
        pass
```

### 9. 主程序

**main.py**

程序入口，负责初始化和启动系统。

```python
# 示例代码结构
import argparse
from config.config_manager import ConfigManager
from db.database import Database
from scheduler.task_scheduler import TaskScheduler
from utils.logger import setup_logger

def main():
    # 解析命令行参数
    parser = argparse.ArgumentParser(description='豆瓣书单同步与 Calibre 集成自动化')
    parser.add_argument('--config', default='config.yaml', help='配置文件路径')
    args = parser.parse_args()
    
    # 初始化配置
    config_manager = ConfigManager(args.config)
    
    # 设置日志
    logger = setup_logger()
    
    # 初始化数据库
    db = Database(config_manager.get_database_url())
    db.init_db()
    
    # 初始化调度器
    scheduler = TaskScheduler(config_manager)
    scheduler.setup_jobs()
    
    try:
        # 启动调度器
        scheduler.start()
        logger.info('系统已启动，按 Ctrl+C 停止')
        # 保持主线程运行
        while True:
            pass
    except KeyboardInterrupt:
        # 停止调度器
        scheduler.stop()
        logger.info('系统已停止')

if __name__ == '__main__':
    main()
```

### 10. 配置文件

**config.yaml**

系统配置文件，包含各模块所需的配置项。

```yaml
douban:
  cookie: "your_douban_cookie"

database:
  type: "sqlite"
  path: "./data/douban_books.db"

calibre:
  content_server_url: "http://localhost:8080"
  username: "your_calibre_user"
  password: "your_calibre_password"

zlibrary:
  username: "your_zlibrary_user"
  password: "your_zlibrary_password"
  format_priority: ["epub", "mobi", "pdf"]

schedule:
  time: "02:00"   # 每日执行时间

lark:
  webhook_url: "https://open.feishu.cn/..."
```

### 11. 依赖包列表

**requirements.txt**

项目依赖的第三方包列表。

```
requests>=2.25.1
beautifulsoup4>=4.9.3
sqlalchemy>=1.4.23
pyyaml>=5.4.1
apscheduler>=3.7.0
zlibrary>=1.0.0
larkpy>=1.0.0
pytest>=6.2.5
```

## 开发流程

1. **环境准备**
   - 创建虚拟环境：`python -m venv venv`
   - 激活虚拟环境：`source venv/bin/activate`（Linux/Mac）或 `venv\Scripts\activate`（Windows）
   - 安装依赖：`pip install -r requirements.txt`

2. **配置设置**
   - 复制 `config.yaml` 并填写相关配置

3. **数据库初始化**
   - 运行 `python -c "from db.database import Database; db = Database('sqlite:///data/douban_books.db'); db.init_db()"`

4. **运行系统**
   - 执行 `python main.py`

5. **测试**
   - 运行单元测试：`pytest tests/`
   - 运行集成测试：`pytest tests/test_integration.py`

## 部署建议

1. **系统要求**
   - Python 3.8+
   - Calibre Content Server 已配置并运行
   - 稳定的网络连接

2. **自动启动**
   - 使用 systemd（Linux）或计划任务（Windows）设置开机自启
   - 配置日志轮转，避免日志文件过大

3. **监控**
   - 定期检查日志文件
   - 设置飞书通知，及时了解系统运行状态

4. **备份**
   - 定期备份数据库文件
   - 保存配置文件的安全副本