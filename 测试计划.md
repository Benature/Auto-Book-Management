# 豆瓣书单同步与 Calibre 集成自动化 - 测试计划

## 测试目标

本测试计划旨在确保「豆瓣书单同步与 Calibre 集成自动化」系统的各个组件和整体功能符合预期要求，具有足够的稳定性、可靠性和安全性。测试将覆盖所有关键功能模块，包括数据采集、书库匹配、下载上传和通知功能。

## 测试范围

### 功能测试

1. **数据采集模块**
   - 豆瓣登录与认证
   - 「想读」书单爬取
   - 数据解析与存储

2. **数据库模块**
   - 数据模型正确性
   - CRUD 操作
   - 事务处理

3. **Calibre 查询模块**
   - 连接与认证
   - 书籍搜索
   - 模糊匹配算法

4. **Z-Library 下载模块**
   - 账号认证
   - 书籍搜索
   - 格式选择与下载

5. **Calibre 上传模块**
   - 文件上传
   - 元数据处理
   - 状态更新

6. **飞书通知模块**
   - 消息格式化
   - 发送机制
   - 错误处理

7. **调度系统**
   - 定时触发
   - 任务管理
   - 错误恢复

### 非功能测试

1. **性能测试**
   - 响应时间
   - 资源使用率
   - 并发处理能力

2. **可靠性测试**
   - 长时间运行稳定性
   - 错误恢复能力
   - 异常处理

3. **安全测试**
   - 敏感信息保护
   - 权限控制
   - 数据完整性

## 测试环境

### 硬件环境

- 处理器：Intel Core i5 或更高
- 内存：8GB 或更高
- 存储：50GB 可用空间
- 网络：稳定的互联网连接

### 软件环境

- 操作系统：Windows 10/11, macOS, Linux
- Python：3.8 或更高版本
- 数据库：SQLite 3.30+ / PostgreSQL 12+
- Calibre：5.0 或更高版本，启用 Content Server
- 浏览器：Chrome 最新版（用于验证结果）

### 测试工具

- 单元测试：pytest
- 性能测试：locust
- 代码覆盖率：coverage.py
- 静态代码分析：flake8, pylint
- 模拟服务：pytest-mock, responses
- 日志分析：自定义脚本

## 测试策略

### 1. 单元测试

**目标**：验证各个模块的独立功能正确性

**方法**：
- 为每个模块编写全面的单元测试
- 使用模拟对象隔离外部依赖
- 测试正常路径和异常路径

**覆盖率目标**：代码覆盖率 80% 以上

### 2. 集成测试

**目标**：验证模块间交互的正确性

**方法**：
- 测试模块组合的功能
- 验证数据流转和状态变化
- 使用测试数据库和模拟外部服务

**关注点**：
- 模块间接口兼容性
- 数据传递的完整性
- 错误处理和恢复机制

### 3. 系统测试

**目标**：验证整个系统的端到端功能

**方法**：
- 模拟真实用户场景
- 执行完整的工作流程
- 验证最终结果的正确性

**关注点**：
- 功能完整性
- 业务流程正确性
- 系统配置的影响

### 4. 性能测试

**目标**：评估系统在不同负载下的性能表现

**方法**：
- 测量关键操作的响应时间
- 监控资源使用情况
- 模拟不同数据量的处理

**指标**：
- 单次同步任务完成时间 < 30 分钟
- CPU 使用率峰值 < 80%
- 内存使用率峰值 < 70%

### 5. 可靠性测试

**目标**：验证系统的稳定性和错误恢复能力

**方法**：
- 长时间运行测试（24小时以上）
- 模拟各种故障情况（网络中断、服务不可用等）
- 验证自动恢复机制

**指标**：
- 连续运行 7 天无崩溃
- 故障恢复成功率 > 95%
- 数据一致性保持率 100%

## 测试用例

### 1. 数据采集模块测试

| 测试 ID | 测试名称 | 前置条件 | 测试步骤 | 预期结果 |
|---------|---------|---------|---------|----------|
| TC-DA-001 | 豆瓣登录验证 | 配置有效的豆瓣 Cookie | 1. 初始化爬虫<br>2. 验证登录状态 | 登录成功，能够访问个人书单 |
| TC-DA-002 | 书单爬取 - 正常情况 | 已登录豆瓣账号 | 1. 爬取「想读」书单<br>2. 解析书籍信息 | 成功获取书单中的所有书籍信息 |
| TC-DA-003 | 书单爬取 - 空书单 | 「想读」书单为空 | 1. 爬取「想读」书单 | 返回空列表，不报错 |
| TC-DA-004 | 书单爬取 - 分页处理 | 「想读」书单超过一页 | 1. 爬取「想读」书单<br>2. 检查是否处理了所有页面 | 成功获取所有页面的书籍信息 |
| TC-DA-005 | 数据解析 - 完整信息 | 有书籍 HTML 数据 | 1. 解析书籍 HTML<br>2. 提取书名、作者等信息 | 正确提取所有字段 |
| TC-DA-006 | 数据解析 - 缺失信息 | 书籍信息不完整 | 1. 解析缺少作者的书籍 HTML | 正确处理缺失字段，不报错 |
| TC-DA-007 | 网络异常处理 | 模拟网络中断 | 1. 在爬取过程中断网络<br>2. 恢复网络后重试 | 正确捕获异常并重试，最终完成爬取 |

### 2. 数据库模块测试

| 测试 ID | 测试名称 | 前置条件 | 测试步骤 | 预期结果 |
|---------|---------|---------|---------|----------|
| TC-DB-001 | 数据库初始化 | 配置有效的数据库连接 | 1. 初始化数据库<br>2. 检查表结构 | 成功创建所有表和索引 |
| TC-DB-002 | 书籍添加 | 数据库已初始化 | 1. 添加新书籍记录<br>2. 查询该记录 | 记录成功添加，状态为 "new" |
| TC-DB-003 | 书籍查询 - 按状态 | 数据库中有不同状态的书籍 | 1. 查询状态为 "matched" 的书籍 | 正确返回所有匹配状态的书籍 |
| TC-DB-004 | 书籍更新 | 数据库中有书籍记录 | 1. 更新书籍状态为 "downloaded"<br>2. 查询该记录 | 状态成功更新 |
| TC-DB-005 | 重复书籍处理 | 数据库中已有相同 URL 的书籍 | 1. 尝试添加相同 URL 的书籍 | 不创建重复记录，更新现有记录 |
| TC-DB-006 | 事务回滚 | 数据库已初始化 | 1. 在事务中执行多个操作<br>2. 触发异常导致回滚 | 所有操作被回滚，数据库保持一致性 |

### 3. Calibre 查询模块测试

| 测试 ID | 测试名称 | 前置条件 | 测试步骤 | 预期结果 |
|---------|---------|---------|---------|----------|
| TC-CQ-001 | Calibre 连接 | Calibre Content Server 运行中 | 1. 初始化连接<br>2. 验证连接状态 | 成功连接到 Calibre 服务器 |
| TC-CQ-002 | 精确匹配查询 | Calibre 中有测试书籍 | 1. 使用完整书名和作者查询 | 正确找到匹配的书籍 |
| TC-CQ-003 | 模糊匹配 - 书名变体 | Calibre 中有测试书籍 | 1. 使用略有不同的书名查询（如缺少副标题） | 正确找到匹配的书籍 |
| TC-CQ-004 | 模糊匹配 - 作者变体 | Calibre 中有测试书籍 | 1. 使用略有不同的作者名查询（如姓名顺序不同） | 正确找到匹配的书籍 |
| TC-CQ-005 | 无匹配结果 | Calibre 中无匹配书籍 | 1. 查询不存在的书籍 | 返回空结果，不报错 |
| TC-CQ-006 | 连接失败处理 | Calibre 服务不可用 | 1. 尝试连接到未运行的服务器 | 正确捕获异常，返回适当的错误信息 |

### 4. Z-Library 下载模块测试

| 测试 ID | 测试名称 | 前置条件 | 测试步骤 | 预期结果 |
|---------|---------|---------|---------|----------|
| TC-ZL-001 | Z-Library 登录 | 有效的账号凭证 | 1. 初始化客户端<br>2. 验证登录状态 | 成功登录 Z-Library |
| TC-ZL-002 | 书籍搜索 - 有结果 | 已登录 Z-Library | 1. 搜索常见书籍 | 返回匹配的搜索结果 |
| TC-ZL-003 | 书籍搜索 - 无结果 | 已登录 Z-Library | 1. 搜索不存在的书籍 | 返回空结果，不报错 |
| TC-ZL-004 | 格式优先级选择 | 搜索结果包含多种格式 | 1. 设置格式优先级 ["epub", "mobi", "pdf"]<br>2. 选择下载格式 | 按优先级选择最高的可用格式 |
| TC-ZL-005 | 书籍下载 | 已找到可下载的书籍 | 1. 下载书籍<br>2. 验证文件完整性 | 成功下载并保存文件 |
| TC-ZL-006 | 下载限制处理 | 模拟达到下载限制 | 1. 触发下载限制<br>2. 等待并重试 | 正确处理限制，实施延迟重试 |
| TC-ZL-007 | 网络中断恢复 | 下载过程中断网络 | 1. 开始下载<br>2. 中断网络<br>3. 恢复网络 | 正确处理中断并恢复下载 |

### 5. Calibre 上传模块测试

| 测试 ID | 测试名称 | 前置条件 | 测试步骤 | 预期结果 |
|---------|---------|---------|---------|----------|
| TC-CU-001 | 文件上传 - EPUB | 有 EPUB 测试文件 | 1. 上传 EPUB 文件到 Calibre | 文件成功上传并添加到书库 |
| TC-CU-002 | 文件上传 - PDF | 有 PDF 测试文件 | 1. 上传 PDF 文件到 Calibre | 文件成功上传并添加到书库 |
| TC-CU-003 | 元数据处理 | 有带元数据的测试文件 | 1. 上传文件<br>2. 检查元数据是否正确提取 | 元数据正确提取并应用 |
| TC-CU-004 | 重复书籍处理 | Calibre 中已有相同书籍 | 1. 尝试上传已存在的书籍 | 检测到重复，不创建副本 |
| TC-CU-005 | 上传失败处理 | 模拟上传失败 | 1. 在上传过程中触发错误 | 正确捕获异常，清理临时文件 |

### 6. 飞书通知模块测试

| 测试 ID | 测试名称 | 前置条件 | 测试步骤 | 预期结果 |
|---------|---------|---------|---------|----------|
| TC-LK-001 | 消息发送 | 有效的 Webhook URL | 1. 发送测试消息 | 消息成功发送到飞书 |
| TC-LK-002 | 任务报告格式化 | 有任务统计数据 | 1. 格式化任务报告<br>2. 发送报告 | 报告格式正确，包含所有统计信息 |
| TC-LK-003 | 长消息处理 | 有超长的任务日志 | 1. 格式化并发送长消息 | 消息被适当截断或分段发送 |
| TC-LK-004 | 发送失败处理 | 无效的 Webhook URL | 1. 尝试发送消息 | 正确捕获异常，记录错误日志 |

### 7. 调度系统测试

| 测试 ID | 测试名称 | 前置条件 | 测试步骤 | 预期结果 |
|---------|---------|---------|---------|----------|
| TC-SC-001 | 定时触发 | 配置每分钟执行一次 | 1. 启动调度器<br>2. 等待 2 分钟 | 任务被准确触发两次 |
| TC-SC-002 | 任务执行 | 调度器已启动 | 1. 触发同步任务<br>2. 监控执行过程 | 任务按预期流程执行完成 |
| TC-SC-003 | 任务失败恢复 | 模拟任务执行失败 | 1. 触发会失败的任务<br>2. 观察重试行为 | 任务按配置的策略重试 |
| TC-SC-004 | 并发任务处理 | 调度器已启动 | 1. 同时触发多个任务 | 任务按优先级或队列正确处理 |

### 8. 系统集成测试

| 测试 ID | 测试名称 | 前置条件 | 测试步骤 | 预期结果 |
|---------|---------|---------|---------|----------|
| TC-SI-001 | 完整工作流 - 新书籍 | 系统完全配置，豆瓣有新书籍 | 1. 启动同步任务<br>2. 观察整个流程 | 新书籍被爬取、下载并上传到 Calibre |
| TC-SI-002 | 完整工作流 - 已有书籍 | 系统完全配置，书籍已在 Calibre 中 | 1. 启动同步任务 | 书籍被正确标记为已匹配，不重复下载 |
| TC-SI-003 | 错误恢复 - 网络中断 | 系统完全配置 | 1. 启动同步任务<br>2. 在过程中断网络<br>3. 恢复网络 | 系统恢复并完成剩余任务 |
| TC-SI-004 | 错误恢复 - 服务不可用 | 系统完全配置，Z-Library 暂时不可用 | 1. 启动同步任务 | 系统正确处理错误，记录失败的书籍，完成其他任务 |

## 测试执行计划

### 阶段 1：单元测试（2天）

- 开发各模块的单元测试
- 确保基本功能正确性
- 达到代码覆盖率目标

### 阶段 2：集成测试（2天）

- 测试模块间交互
- 验证数据流转
- 检查错误处理

### 阶段 3：系统测试（3天）

- 执行端到端测试
- 验证完整工作流
- 测试配置变化的影响

### 阶段 4：性能与可靠性测试（2天）

- 执行性能基准测试
- 进行长时间运行测试
- 模拟各种故障情况

### 阶段 5：回归测试（1天）

- 修复发现的问题
- 执行回归测试
- 确保修复不引入新问题

## 测试环境设置

### 开发测试环境

1. **环境准备**
   ```bash
   # 创建虚拟环境
   python -m venv venv
   source venv/bin/activate  # Linux/Mac
   # venv\Scripts\activate  # Windows
   
   # 安装依赖
   pip install -r requirements.txt
   pip install pytest pytest-cov pytest-mock responses
   
   # 初始化测试数据库
   python -c "from db.database import Database; db = Database('sqlite:///data/test.db'); db.init_db()"
   ```

2. **测试数据准备**
   - 创建测试用的豆瓣书单数据
   - 准备测试用的电子书文件
   - 设置模拟服务器响应

3. **Calibre 测试环境**
   ```bash
   # 启动 Calibre Content Server（测试用）
   calibre-server --port=8080 --username=test --password=test /path/to/test/library
   ```

## 测试报告模板

### 测试摘要

| 类别 | 总数 | 通过 | 失败 | 跳过 | 通过率 |
|------|------|------|------|------|--------|
| 单元测试 |  |  |  |  |  |
| 集成测试 |  |  |  |  |  |
| 系统测试 |  |  |  |  |  |
| 性能测试 |  |  |  |  |  |
| 总计 |  |  |  |  |  |

### 测试详情

#### 失败的测试

| 测试 ID | 测试名称 | 失败原因 | 严重程度 | 状态 |
|---------|---------|---------|---------|------|
|  |  |  |  |  |

#### 性能测试结果

| 测试场景 | 平均响应时间 | 最大响应时间 | CPU 使用率 | 内存使用率 |
|---------|------------|------------|-----------|----------|
|  |  |  |  |  |

### 问题与建议

1. **发现的问题**
   - 问题描述
   - 复现步骤
   - 影响范围

2. **改进建议**
   - 功能改进
   - 性能优化
   - 代码质量提升

## 测试完成标准

1. **功能完整性**
   - 所有测试用例执行完毕
   - 关键功能测试通过率 100%
   - 非关键功能测试通过率 ≥ 95%

2. **性能达标**
   - 满足性能指标要求
   - 资源使用在可接受范围内

3. **可靠性验证**
   - 长时间运行测试通过
   - 错误恢复机制有效

4. **文档完整**
   - 测试报告完整记录
   - 发现的问题已记录并分类
   - 测试数据和环境配置已归档

## 附录：测试数据

### 测试账号

- 豆瓣测试账号（仅用于测试）
- Z-Library 测试账号（仅用于测试）
- Calibre Content Server 测试账号

### 测试书籍样本

| 书名 | 作者 | 格式 | 用途 |
|------|------|------|------|
| 《测试驱动开发》 | Kent Beck | EPUB | 基本功能测试 |
| 《设计模式》 | Erich Gamma 等 | PDF | 元数据提取测试 |
| 《算法导论》 | Thomas H. Cormen 等 | MOBI | 格式处理测试 |

### 模拟响应数据

- 豆瓣书单 HTML 样本
- Calibre API 响应样本
- Z-Library 搜索结果样本